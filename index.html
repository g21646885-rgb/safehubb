<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Hub | Final Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f172a; --side: #1e293b; --accent: #8b5cf6; --text: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Экран входа */
        #authScreen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .auth-card { background: var(--side); padding: 30px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; outline: none; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { opacity: 0.8; }

        /* Основной интерфейс */
        .sidebar { width: 350px; background: var(--side); border-right: 1px solid #334155; display: flex; flex-direction: column; }
        .tabs { display: flex; background: #111827; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-size: 12px; opacity: 0.6; }
        .tab.active { opacity: 1; border-bottom: 2px solid var(--accent); color: var(--accent); }
        
        .main { flex: 1; display: flex; flex-direction: column; background: #020617; }
        header { padding: 15px 25px; background: var(--side); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 14px; position: relative; }
        .sent { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: #334155; border-bottom-left-radius: 2px; }
        
        footer { padding: 15px; background: var(--side); display: flex; gap: 10px; }
        #callOverlay { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .user-item { padding: 15px; border-bottom: 1px solid #334155; cursor: pointer; transition: 0.2s; }
        .user-item:hover { background: #334155; }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-card">
            <h2 style="color: var(--accent); margin-bottom: 10px;">Safe Hub</h2>
            <p style="font-size: 12px; margin-bottom: 20px; opacity: 0.7;">Защищенный мессенджер</p>
            
            <div id="phoneStep">
                <input type="text" id="phoneNum" placeholder="+7 777 000 00 00">
                <div id="recaptcha-container"></div>
                <button class="btn" onclick="sendSMS()">Получить код</button>
            </div>
            
            <div id="codeStep" style="display: none;">
                <input type="text" id="smsCode" placeholder="Код из SMS">
                <button class="btn" onclick="confirmSMS()">Войти</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div id="myInfo" style="padding: 20px; border-bottom: 1px solid #334155; font-size: 14px; color: var(--accent);">Загрузка...</div>
        <div class="tabs">
            <div class="tab active" id="tabUsers" onclick="switchTab('users')">КОНТАКТЫ</div>
            <div class="tab" id="tabGroups" onclick="switchTab('groups')">ГРУППЫ</div>
        </div>
        <div id="list" style="flex: 1; overflow-y: auto;"></div>
        <button onclick="addGroup()" style="padding: 15px; background: #22c55e; border: none; color: white; cursor: pointer; font-weight: bold;">+ СОЗДАТЬ ГРУППУ</button>
    </div>

    <div class="main">
        <header>
            <b id="activeChat">Выберите чат</b>
            <div style="display: flex; gap: 20px;">
                <i class="fas fa-phone" onclick="startCall(false)" style="cursor:pointer;"></i>
                <i class="fas fa-video" onclick="startCall(true)" style="cursor:pointer; color: var(--accent);"></i>
            </div>
        </header>
        <div class="messages" id="msgBox"></div>
        <footer>
            <input type="text" id="msgInp" placeholder="Написать сообщение..." onkeypress="if(event.key==='Enter')send()">
            <button onclick="send()" class="btn" style="width: auto; padding: 10px 25px;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </footer>
    </div>

    <div id="callOverlay">
        <video id="remoteVideo" autoplay></video>
        <button onclick="location.reload()" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); padding:15px 40px; background:#ef4444; color:white; border-radius:30px; border:none; font-weight:bold; cursor:pointer;">Завершить</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Твой актуальный конфиг
        const firebaseConfig = {
            apiKey: "AIzaSyCGAxQalQWQD9BB2ExxBuGKG0zMmSUmnj4",
            authDomain: "planning-with-ai-948ba.firebaseapp.com",
            databaseURL: "https://planning-with-ai-948ba-default-rtdb.firebaseio.com",
            projectId: "planning-with-ai-948ba",
            storageBucket: "planning-with-ai-948ba.firebasestorage.app",
            messagingSenderId: "496797499992",
            appId: "1:496797499992:web:d8045ead0ee7efcf61c02d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const peer = new Peer();

        let currentUser, confirmationResult, myPeerId, targetId, currentMode = 'users';

        // Инициализация ReCAPTCHA при загрузке
        window.onload = () => {
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'invisible'
            });
        };

        // ОТПРАВКА SMS
        window.sendSMS = () => {
            const phoneNumber = document.getElementById('phoneNum').value;
            if(!phoneNumber.includes('+')) return alert("Введите номер с + (например +7...)");
            
            signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
                .then(res => {
                    confirmationResult = res;
                    document.getElementById('phoneStep').style.display = 'none';
                    document.getElementById('codeStep').style.display = 'block';
                }).catch(err => {
                    console.error(err);
                    alert("Ошибка входа! ПроверьтеAuthorized Domains в Firebase или используйте тестовый номер.");
                });
        };

        // ПОДТВЕРЖДЕНИЕ КОДА
        window.confirmSMS = () => {
            const code = document.getElementById('smsCode').value;
            confirmationResult.confirm(code).then(result => {
                // Вход успешен
            }).catch(() => alert("Неверный код!"));
        };

        // ПРОВЕРКА СТАТУСА ВХОДА
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('myInfo').innerText = "Ваш номер: " + user.phoneNumber;
                initPeerConnection();
            }
        });

        // PEER-TO-PEER
        function initPeerConnection() {
            peer.on('open', id => {
                myPeerId = id;
                // Регистрируем себя в базе как онлайн
                set(ref(db, 'online/' + id), { id, name: currentUser.phoneNumber });
                onDisconnect(ref(db, 'online/' + id)).remove();
                loadList();
            });

            peer.on('connection', conn => {
                conn.on('data', data => {
                    if(targetId === data.fromId) {
                        appendMsg(data.fromName, data.text, 'received');
                    }
                });
            });

            peer.on('call', call => {
                if(confirm("Входящий звонок! Ответить?")) {
                    navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                        document.getElementById('callOverlay').style.display = 'block';
                        call.answer(stream);
                        call.on('stream', remoteStream => {
                            document.getElementById('remoteVideo').srcObject = remoteStream;
                        });
                    });
                }
            });
        }

        // ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК
        window.switchTab = (mode) => {
            currentMode = mode;
            document.getElementById('tabUsers').classList.toggle('active', mode === 'users');
            document.getElementById('tabGroups').classList.toggle('active', mode === 'groups');
            loadList();
        };

        // ЗАГРУЗКА СПИСКА
        function loadList() {
            const path = currentMode === 'users' ? 'online/' : 'groups/';
            onValue(ref(db, path), snap => {
                const listDiv = document.getElementById('list');
                listDiv.innerHTML = "";
                snap.forEach(child => {
                    const item = child.val();
                    if(item.id === myPeerId) return;
                    
                    const div = document.createElement('div');
                    div.className = "user-item";
                    div.innerHTML = `<b>${item.name}</b><br><small style="opacity:0.5">${currentMode === 'users' ? 'Online' : 'Групповой чат'}</small>`;
                    div.onclick = () => {
                        targetId = item.id;
                        document.getElementById('activeChat').innerText = item.name;
                        document.getElementById('msgBox').innerHTML = "";
                        if(currentMode === 'groups') loadGroupMessages(item.id);
                    };
                    listDiv.appendChild(div);
                });
            });
        }

        // ОТПРАВКА СООБЩЕНИЯ
        window.send = () => {
            const text = document.getElementById('msgInp').value;
            if(!text || !targetId) return;

            if(currentMode === 'groups') {
                push(ref(db, 'group_messages/' + targetId), {
                    from: currentUser.phoneNumber,
                    text: text,
                    timestamp: Date.now()
                });
            } else {
                const conn = peer.connect(targetId);
                conn.on('open', () => {
                    conn.send({ fromId: myPeerId, fromName: currentUser.phoneNumber, text: text });
                    appendMsg("Вы", text, 'sent');
                });
            }
            document.getElementById('msgInp').value = "";
        };

        // ЗАГРУЗКА СООБЩЕНИЙ ГРУППЫ
        function loadGroupMessages(groupId) {
            onValue(ref(db, 'group_messages/' + groupId), snap => {
                document.getElementById('msgBox').innerHTML = "";
                snap.forEach(m => {
                    const data = m.val();
                    appendMsg(data.from, data.text, data.from === currentUser.phoneNumber ? 'sent' : 'received');
                });
            });
        }

        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        function appendMsg(name, text, type) {
            const box = document.getElementById('msgBox');
            const html = `<div class="msg ${type}">
                            <div style="font-size:10px; opacity:0.6; margin-bottom:4px;">${name}</div>
                            ${text}
                          </div>`;
            box.insertAdjacentHTML('beforeend', html);
            box.scrollTop = box.scrollHeight;
        }

        window.addGroup = () => {
            const name = prompt("Введите название группы:");
            if(name) {
                const gid = "group_" + Date.now();
                set(ref(db, 'groups/' + gid), { id: gid, name: name });
            }
        };

        window.startCall = (withVideo) => {
            if(!targetId) return alert("Сначала выберите контакт");
            navigator.mediaDevices.getUserMedia({video: withVideo, audio: true}).then(stream => {
                document.getElementById('callOverlay').style.display = 'block';
                const call = peer.call(targetId, stream);
                call.on('stream', remoteStream => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                });
            });
        };
    </script>
</body>

</html>
